<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Detector</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Emotion Detection App</h1>
        <p>Upload a photo or use your camera!</p>

        <input type="text" id="name" placeholder="Enter your name" required>
        <br><br>

        <!-- Upload Image -->
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="file" id="fileInput" accept="image/*">
            <button type="button" onclick="uploadImage()">Upload & Detect</button>
        </form>

        <hr>

        <!-- Live Camera -->
        <h3>Or Use Camera</h3>
        <video id="video" width="320" height="240" autoplay></video>
        <br>
        <button type="button" onclick="takePhoto()">Take Photo & Detect</button>

        <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

        <h2 id="result" style="min-height: 50px;"></h2>
    </div>

  <script>
    // Start camera
    const video = document.getElementById('video');
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => video.srcObject = stream)
        .catch(err => alert("Camera error: " + err.message));

    // Take photo from camera
    function takePhoto() {
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, 320, 240);
        const imageData = canvas.toDataURL('image/jpeg');  // â† Force JPEG

        const name = document.getElementById('name').value.trim();
        if (!name) return alert("Please enter your name!");

        sendImage(imageData, name, 'camera');
    }

    // Upload file
    function uploadImage() {
        const fileInput = document.getElementById('fileInput');
        const name = document.getElementById('name').value.trim();
        if (!name) return alert("Please enter your name!");
        if (!fileInput.files[0]) return alert("Choose an image!");

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('name', name);

        fetch('/predict', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => showResult(data, name))
        .catch(err => alert("Error: " + err));
    }

    // Send camera image
    function sendImage(imageData, name, type) {
        const formData = new FormData();
        formData.append('image', imageData);
        formData.append('name', name);

        fetch('/predict', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => showResult(data, name))
        .catch(err => alert("Error: " + err));
    }

    // Show result on page
    function showResult(data, name) {
        const resultDiv = document.getElementById('result');
        if (data.emotion) {
            resultDiv.innerHTML = `<strong>${name}, you look: <span style="color: #ff6b6b;">${data.emotion}</span>!</strong>`;
            resultDiv.style.color = 'white';
            resultDiv.style.fontSize = '1.5em';
        } else {
            resultDiv.innerHTML = `<span style="color: red;">Error: ${data.error}</span>`;
        }
    }
</script>
</body>
</html>